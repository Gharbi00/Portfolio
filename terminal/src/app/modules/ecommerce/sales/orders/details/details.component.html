<app-breadcrumbs title="{{ 'MENUITEMS.TITLE.ADD_ORDER' | translate }}" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>
<ng-container *ngIf="!(navigating$ | async)">

  <div class="row">
    <div class="col-xl-8">
      <div class="card">
        <div class="card-body checkout-tab">

          <div class="step-arrow-nav mt-n3 mx-n3 mb-3">
            <ul ngbNav #customNav="ngbNav" (navChange)="onNavChange($event)" [activeId]="selectedNav"
              class="nav nav-pills custom-nav nav-justified" role="tablist">
              <li [ngbNavItem]="1" class="nav-item">
                <a ngbNavLink class="nav-link fs-15 p-3" data-bs-toggle="tab" role="tab">
                  <i
                    class="ri-dashboard-line fs-16 p-2 bg-soft-primary text-primary rounded-circle align-middle mx-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.ARTICLE' | translate }}
                </a>
                <ng-template ngbNavContent>
                  <form [formGroup]="orderForm">
                    <div class="row">
                      <div class="col-lg-12 mb-3">
                        <label for="email_id-field" class="form-label">{{ 'COMMON.ARTICLE' | translate }}*</label>
                        <ng-select #articleSelect (change)="selectArticle($event)" placeholder="{{'PLACEHOLDER.CHOOSE_AN_ARTICLE' | translate }}"
                          bindValue="id" required [multiple]="false" [typeahead]="barcodeSearchInput$"
                          [virtualScroll]="true" (scrollToEnd)="loadMoreBarcodes()" [items]="barcodes$ | async">
                          <ng-template ng-label-tmp let-item="item" let-clear="clear">
                            <span class="ng-value-label">
                              {{item?.name}}
                            </span>
                            <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">×</span>
                          </ng-template>
                          <ng-template ng-option-tmp let-item$="item$" let-item="item">
                            <div class="d-flex align-items-center">
                              <div class="flex-shrink-0 me-3">
                                <div class="avatar-sm bg-light p-1 rounded" *ngIf="item?.media?.pictures?.length">
                                  <img [src]="item?.media?.pictures[0]?.baseUrl + '/' + item?.media?.pictures[0]?.path"
                                    class="img-fluid h-100 d-block">
                                </div>
                                <div class="avatar-sm bg-light rounded p-1" *ngIf="!item?.media?.pictures?.length">
                                  <div class="avatar-title bg-soft-success text-success rounded fs-13">
                                    {{item?.name?.charAt(0) || 'N'}}</div>
                                </div>
                              </div>
                              <span class="flex-grow-1 ms-2">
                                {{item?.name}}
                              </span>
                            </div>
                          </ng-template>
                        </ng-select>
                      </div>
                      <ng-container formGroupName="discount">
                        <div class="mb-3">
                          <label for="choices-privacy-status-input" class="form-label">{{ 'MODULES.ECOMMERCE.MAIN.DISCOUNT_TYPE' | translate }}</label>
                          <ng-select (change)="onChangeDiscount($event)" placeholder="{{'PLACEHOLDER.CHOOSE_DISCOUNT_TYPE' | translate }}" [multiple]="false" [items]="discountTypes"
                            [formControlName]="'discountType'">
                            <ng-template ng-label-tmp let-item="item">
                              {{
                              item === 'AMOUNT' ? 'COMMON.AMOUNT' :
                              'SHARED.PERCENTAGE'
                              }}
                            </ng-template>
                            <ng-template ng-option-tmp let-item="item">
                              {{
                              item === 'AMOUNT' ? 'COMMON.AMOUNT' :
                              'SHARED.PERCENTAGE'
                              }}
                            </ng-template>
                          </ng-select>
                        </div>
                        <div *ngIf="orderForm.get('discount')?.value?.discountType" class="mb-3">
                          <label for="email_id-field" class="form-label">{{ 'MODULES.ECOMMERCE.MAIN.DISCOUNT_AMOUNT' | translate }}</label>
                          <div class="input-group">
                            <input type="number" id="email_id-field" class="form-control" placeholder="{{'PLACEHOLDER.ENTER_AMOUNT' | translate }}"
                              formControlName="amount" />
                            <div class="input-group-append">
                              <span class="input-group-text">
                                {{ orderForm.get('discount').value.discountType === 'PERCENTAGE' ? '%' : 'DT'}}</span>
                            </div>
                          </div>
                        </div>
                      </ng-container>
                    </div>
                  </form>
                  <div class="col-lg-12">
                    <div class="justify-content-end gap-1 d-flex">
                      <button (click)="addProduct()" [disabled]="!selectedProduct?.barcode" type="button"
                        class="btn btn-secondary">{{ 'MODULES.ECOMMERCE.MAIN.ADD_ARTICLE' | translate }}</button>
                      <button [disabled]="!products.value?.length" (click)="goToInfo()" type="button"
                        class="btn btn-primary btn-label right nexttab" data-nexttab="pills-bill-address-tab"><i
                          class="ri-truck-line label-icon align-middle fs-16 ms-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.PROCEED_TO_PERSONAL_INFO' | translate }}</button>
                    </div>
                  </div>
                </ng-template>
              </li>
              <li [ngbNavItem]="2" class="nav-item">
                <a ngbNavLink class="nav-link fs-15 p-3" data-bs-toggle="tab" role="tab">
                  <i class="ri-user-2-line fs-16 p-2 bg-soft-primary text-primary rounded-circle align-middle mx-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.PERSONAL_INFO' | translate }}
                </a>
                <ng-template ngbNavContent>
                  <div class="d-flex justify-content-between">
                    <div>
                      <h5 class="mb-1">{{ 'MODULES.ECOMMERCE.MAIN.BILLING_INFORMATION' | translate }}</h5>
                      <p class="text-muted mb-4">{{ 'MODULES.ECOMMERCE.MAIN.PLEASE_FILL_ALL_INFORMATION_BELOW' | translate }}</p>
                    </div>
                    <div *ngIf="!addView">
                      <a (click)="addCustomer()" class="btn btn-soft-info btn-sm mt-2 mt-sm-0 shadow-none"><i
                          class="ri-add-line align-middle me-1"></i>{{ 'MODULES.ECOMMERCE.MAIN.ADD_CUSTOMER' | translate }}</a>
                    </div>
                  </div>
                  <div>
                    <form *ngIf="!addView" [formGroup]="orderForm">
                      <div class="col-lg-12 mb-3">
                        <label for="email_id-field" class="form-label">{{ 'COMMON.CUSTOMER' | translate }}*</label>
                        <ng-select [(ngModel)]="selectedUser" [ngModelOptions]="{standalone: true}"
                          (change)="onSelectUser($event)" placeholder="{{'PLACEHOLDER.CHOOSE_A_CUSTOMER' | translate }}" required [multiple]="false"
                          [typeahead]="userSearchInput$" [virtualScroll]="true" (scrollToEnd)="loadMoreUsers()"
                          [items]="users$ | async">
                          <ng-template ng-label-tmp let-item="item" let-clear="clear">
                            <span class="ng-value-label">
                              {{item?.firstName}} {{item?.lastName}}
                            </span>
                            <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">×</span>
                          </ng-template>
                          <ng-template ng-option-tmp let-item$="item$" let-item="item">
                            <div class="d-flex align-items-center">
                              <div class="flex-shrink-0 me-3">
                                <div class="avatar-sm bg-light p-1 rounded-circle" *ngIf="item?.picture?.baseUrl">
                                  <img [src]="item?.picture?.baseUrl + '/' + item?.picture?.path"
                                    class="img-fluid h-100 d-block">
                                </div>
                                <div class="avatar-sm bg-light rounded-circle p-1" *ngIf="!item?.picture?.baseUrl">
                                  <div class="avatar-title bg-soft-success text-success rounded-circle fs-13">
                                    {{item?.firstName?.charAt(0) || 'N'}}</div>
                                </div>
                              </div>
                              <span class="flex-grow-1 ms-2">
                                {{item?.firstName}} {{item?.lastName}}
                              </span>
                            </div>
                          </ng-template>
                        </ng-select>
                      </div>
                    </form>
                    <div *ngIf="addView">
                      <form [formGroup]="customerForm">
                        <div class="row">
                          <div class="mb-3 col-sm-6">
                            <label for="billinginfo-firstName" class="form-label">{{ 'COMMON.FIRST_NAME' | translate }}</label>
                            <input formControlName="firstName" type="text" class="form-control"
                              id="billinginfo-firstName" placeholder="{{'PLACEHOLDER.ENTER_FIRSTNAME' | translate }}">
                          </div>
                          <div class="mb-3 col-sm-6">
                            <label for="billinginfo-lastName" class="form-label">{{ 'COMMON.LAST_NAME' | translate }}</label>
                            <input type="text" formControlName="lastName" class="form-control" id="billinginfo-lastName"
                              placeholder="{{'PLACEHOLDER.ENTER_LAST_NAME' | translate }}">
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm-12 mb-3">
                            <label for="billinginfo-email" class="form-label">{{ 'COMMON.EMAIL' | translate }} </label>
                            <input formControlName="email" type="email" required class="form-control"
                              id="billinginfo-email" placeholder="{{'PLACEHOLDER.ENTER_EMAIL' | translate }}">
                          </div>
                        </div>
                        <ng-container formGroupName="residentialAddress">
                          <div class="mb-3">
                            <label for="billinginfo-address" class="form-label">{{'COMMON.ADDRESS' | translate }} line*</label>
                            <textarea formControlName="address" class="form-control" id="billinginfo-address"
                              placeholder="{{'PLACEHOLDER.ENTER_ADDRESS' | translate }}" rows="3"></textarea>
                          </div>
                          <div class="row">
                            <div class="mb-3 col-sm-6">
                              <label for="country" class="form-label">{{ 'COMMON.COUNTRY' | translate }}</label>
                              <select class="form-select form-control-line" [formControlName]="'country'">
                                <option *ngFor="let country of allCountries" [value]="country.id">
                                  <div fxLayout="row" fxLayoutAlign="space-between">
                                    <span>{{ country.name.split('_').join(' ') | titlecase }}</span>
                                    <span *ngIf="country?.iconFlag">{{country.iconFlag}}</span>
                                  </div>
                                </option>
                              </select>
                            </div>
                            <div class="mb-3 col-sm-6">
                              <label for="state" class="form-label">State</label>
                              <select class="form-select form-control-line" [formControlName]="'state'">
                                <option *ngFor="let state of states" [value]="state.id">
                                  {{  'COMMON.STATE.' + state | translate }}
                                </option>
                              </select>
                            </div>
                            <div class="mb-3 col-sm-6">
                              <label for="zip" class="form-label">{{ 'COMMON.CITY' | translate }}</label>
                              <input formControlName="city" type="text" class="form-control" id="zip"
                                placeholder="{{'PLACEHOLDER.ENTER_ZIP_CODE' | translate }}">
                            </div>
                            <div class="mb-3 col-sm-6">
                              <div class="mb-3">
                                <label for="zip" class="form-label">{{ 'COMMON.ZIP_CODE' | translate }}</label>
                                <input formControlName="postCode" type="text" class="form-control" id="zip"
                                  placeholder="{{'PLACEHOLDER.ENTER_ZIP_CODE' | translate }}">
                              </div>
                            </div>
                          </div>
                        </ng-container>
                        <div *ngIf="addView" class="justify-content-end d-flex">
                          <button (click)="exitAddView()" class="btn btn-soft-danger mt-2 me-2 mt-sm-0 shadow-none"><i
                              class="mdi mdi-archive-remove-outline align-middle me-1"></i>{{ 'COMMON.CANCEL' | translate }} </button>
                          <button (click)="saveCustomer()" [disabled]="customerForm.invalid" type="button"
                            class="btn btn-primary btn-label right nexttab"
                            data-nexttab="pills-bill-address-tab">{{'COMMON.SAVE' | translate }}</button>
                        </div>
                      </form>
                    </div>
                    <div class="d-flex align-items-start gap-3 mt-4">
                      <button *ngIf="!addView" (click)="backToArticle()" type="button"
                        class="btn btn-light btn-label previestab" data-previous="pills-bill-info-tab"><i
                          class="ri-arrow-left-line label-icon align-middle fs-16 me-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.BACK_TO_ARTICLE' | translate }}</button>
                      <button [disabled]="orderForm.get('user')?.invalid" (click)="goToShipping()" type="button"
                        class="btn btn-primary btn-label right ms-auto  nexttab"
                        data-nexttab="pills-bill-address-tab"><i
                          class="ri-truck-line label-icon align-middle fs-16 ms-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.PROCEED_TO_SHIPPING' | translate }}</button>
                    </div>
                  </div>
                </ng-template>
              </li>
              <li [ngbNavItem]="3" class="nav-item">
                <a ngbNavLink class="nav-link fs-15 p-3" data-bs-toggle="tab" role="tab">
                  <i class="ri-truck-line fs-16 p-2 bg-soft-primary text-primary rounded-circle align-middle mx-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.SHIPPING_INFO' | translate }}
                </a>
                <ng-template ngbNavContent>
                  <div>
                    <h5 class="mb-1">{{ 'MODULES.ECOMMERCE.MAIN.SHIPPING_INFO' | translate }}</h5>
                    <p class="text-muted mb-4">{{ 'MODULES.ECOMMERCE.MAIN.PLEASE_FILL_ALL_INFORMATION_BELOW' | translate }}</p>
                  </div>
                  <div class="mt-4">
                    <h5 class="fs-14 mb-3">{{ 'MODULES.ECOMMERCE.MAIN.SHIPPING_METHOD' | translate }}</h5>
                    <div class="row g-4">
                      <div class="col-lg-6">
                        <div class="form-check card-radio">
                          <input [checked]="orderForm.get('orderType').value === 'DELIVERY'"
                            (change)="onChangeOrderType($event.target.value)" value="DELIVERY" id="shippingMethod02"
                            type="radio" class="form-check-input">
                          <label class="form-check-label" for="shippingMethod02">
                            <span class="fs-14 mb-1 text-wrap d-block">{{ 'MODULES.ECOMMERCE.MAIN.DELIVERY' | translate }}</span>
                          </label>
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <div class="form-check card-radio">
                          <input [checked]="orderForm.get('orderType').value === 'PICKUP'"
                            (change)="onChangeOrderType($event.target.value)" value="PICKUP" id="shippingMethod01"
                            type="radio" class="form-check-input">
                          <label class="form-check-label" for="shippingMethod01">
                            <span class="fs-14 mb-1 text-wrap d-block">{{ 'MODULES.ECOMMERCE.MAIN.PICKUP' | translate }}</span>
                          </label>
                        </div>
                      </div>
                    </div>
                    <ng-container *ngIf="deliveryView && selectedUser">
                      <div class="d-flex align-items-center mt-4 mb-2">
                        <div class="flex-grow-1">
                          <h5 class="fs-14 mb-0">{{'COMMON.SAVE' | translate }}d Address</h5>
                        </div>
                        <div class="flex-shrink-0">
                          <a (click)="openEditAddressModal(locationModal, null)"
                            class="btn btn-soft-info btn-sm mt-2 mt-sm-0 shadow-none"><i
                              class="ri-add-line align-middle me-1"></i>{{ 'MODULES.ECOMMERCE.MAIN.ADD_ADDRESS' | translate }}</a>
                        </div>
                      </div>
                      <div class="row gy-3 mb-4">
                        <div (click)="onSelectShip(i)"
                          *ngFor="let address of selectedUser?.shippingAddress; let i = index"
                          class="col-lg-4 col-sm-6">
                          <div class="form-check card-radio">
                            <input [checked]="selectedShipIndex === i" id="shippingAddress{{i}}" name="shippingAddress"
                              type="radio" class="form-check-input">
                            <label class="form-check-label" for="shippingAddress01">
                              <span class="mb-4 fw-semibold d-block text-muted text-uppercase">{{ 'MODULES.ECOMMERCE.MAIN.SHIPPING_ADDRESS' | translate }}</span>
                              <span class="fs-14 mb-2 d-block">{{selectedUser?.firstName}}
                                {{selectedUser?.lastName}}</span>
                              <span class="text-muted fw-normal text-wrap mb-1 d-block">{{address?.address}}</span>
                              <span *ngIf="address?.phone?.number" class="text-muted fw-normal d-block">{{'+' +
                                (selectedUser?.phone?.countryCode ||
                                '216')}}
                                {{selectedUser?.phone?.number}}</span>
                            </label>
                          </div>
                          <div class="d-flex flex-wrap p-2 py-1 bg-light rounded-bottom border mt-n1">
                            <div>
                              <a href="javascript:void(0);" class="d-block text-body p-1 px-2" data-bs-toggle="modal"
                                data-bs-target="#addAddressModal" (click)="openEditAddressModal(locationModal, i)"><i
                                  class="ri-pencil-fill text-muted align-bottom me-1"></i>{{ 'COMMON.EDIT' | translate }}</a>
                            </div>
                            <div>
                              <a href="javascript:void(0);" class="d-block text-body p-1 px-2" data-bs-toggle="modal"
                                data-bs-target="#removeItemModal" (click)="openDeleteModal(deleteModel, i)">
                                <i class="ri-delete-bin-fill text-muted align-bottom me-1"></i>{{ 'COMON.REMOVE' | translate }}
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                      <h5 class="fs-14 mb-3">{{ 'MODULES.ECOMMERCE.MAIN.SHIPPING_FEES' | translate }}</h5>
                      <form [formGroup]="orderForm">
                        <ng-container formGroupName="fees">
                          <div class="mb-2">
                            <div class="form-check">
                              <input value="CUSTOM" formControlName="feesType"
                                [checked]="orderForm?.get(['fees', 'feesType'])?.value === 'CUSTOM'"
                                (change)="onChangeShippingFees('CUSTOM')" class="form-check-input" type="radio"
                                id="customId" name="feesType">
                              <label class="form-check-label" for="customId">{{ 'MODULES.ECOMMERCE.MAIN.CUSTOM' | translate }}
                              </label>
                            </div>
                            <div class="form-check">
                              <input value="DEFAULT" formControlName="feesType"
                                [checked]="orderForm?.get(['fees', 'feesType'])?.value === 'DEFAULT'"
                                (change)="onChangeShippingFees('DEFAULT')" class="form-check-input" type="radio"
                                id="defaultId" name="feesType">
                              <label class="form-check-label" for="defaultId">{{ 'MODULES.ECOMMERCE.MAIN.DEFAULT' | translate }}
                              </label>
                            </div>
                          </div>
                          <ng-container *ngIf="orderForm?.get(['fees', 'feesType'])?.value === 'CUSTOM'">
                            <div class="d-flex flex-column gap-2 mb-2">
                              <div *ngFor="let zone of deliveryZones; let i = index" (click)="onSelectZone(i)"
                                class="col-lg-6">
                                <div class="form-check card-radio">
                                  <input [checked]="selectedZoneIndex === i"
                                    (change)="onChangeOrderType($event.target.value)" value="DELIVERY"
                                    id="shippingMethod02" type="radio" class="form-check-input">
                                  <label class="form-check-label" for="shippingMethod02">
                                    <span class="fs-14 mb-1 text-wrap d-block"> {{zone?.extraFees |
                                      currency:'DT':'symbol':'1.3-3'}} </span>
                                  </label>
                                </div>
                              </div>
                            </div>
                            <div (click)="onSelectZone(null)" class="col-lg-6">
                              <div class="form-check card-radio">
                                <input [checked]="selectedZoneIndex === i"
                                  (change)="onChangeOrderType($event.target.value)" value="DELIVERY"
                                  id="shippingMethod02" type="radio" class="form-check-input">
                                <div class="input-group">
                                  <input (change)="onChangeCustomFees($event)" formControlName="amount" type="text"
                                    class="form-control" id="zip" placeholder="{{'PLACEHOLDER.ENTER_DELIVERY_FEES' | translate }}">
                                  <span class="input-group-text">DT</span>
                                </div>
                              </div>
                            </div>
                          </ng-container>
                        </ng-container>
                      </form>
                    </ng-container>
                  </div>
                  <div class="d-flex align-items-start gap-3 mt-4">
                    <button (click)="backToPersonalInfo()" type="button" class="btn btn-light btn-label previestab"
                      data-previous="pills-bill-info-tab"><i
                        class="ri-arrow-left-line label-icon align-middle fs-16 me-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.BACK_TO_PERSONAL_INFO' | translate }}</button>
                    <button (click)="goToPayment()"
                      [disabled]="!selectedShipAddress && orderForm.get('orderType').value !== 'PICKUP'" type="button"
                      class="btn btn-primary btn-label right ms-auto nexttab" data-nexttab="pills-payment-tab">
                      <i class="ri-bank-card-line label-icon align-middle fs-16 ms-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.CONTINUE_TO_PAYMENT' | translate }}
                    </button>
                  </div>
                </ng-template>
              </li>
              <li [ngbNavItem]="4" class="nav-item">
                <a ngbNavLink class="nav-link fs-15 p-3" data-bs-toggle="tab" role="tab">
                  <i
                    class="ri-bank-card-line fs-16 p-2 bg-soft-primary text-primary rounded-circle align-middle mx-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.PAYMENT_INFO' | translate }}
                </a>
                <ng-template ngbNavContent>
                  <div>
                    <h5 class="mb-1">{{ 'MODULES.ECOMMERCE.MAIN.PAYMENT_SELECTION' | translate }}</h5>
                    <p class="text-muted mb-4">{{ 'MODULES.ECOMMERCE.MAIN.PLEASE_SELECT_AND_ENTER_YOUR_BILLING_INFORMATION' | translate }}</p>
                  </div>
                  <div id="noresult" class="py-4 mt-4 text-center" *ngIf="!installmentsList?.length">
                    <lord-icon trigger="loop" style="width:72px;height:72px" [colors]="'primary:' + primaryColor + ',secondary:' + secondaryColor"
                      src="https://cdn.lordicon.com/vlycxjwx.json">
                    </lord-icon>
                    <h5 class="mt-4">{{ 'MODULES.ECOMMERCE.MAIN.SORRY_NO_INSTALLMENTS_FOUND' | translate }}</h5>
                  </div>
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="mb-3 mt-3">
                      <h5>{{ 'MODULES.ECOMMERCE.MAIN.INSTALLMENTS' | translate }}</h5>
                      <span class="text-danger">{{ 'MODULES.ECOMMERCE.MAIN.BALANCE' | translate }}: {{ resAmount | currency:'DT':'symbol':'1.3-3' }}
                      </span>
                    </div>
                    <button [disabled]="resAmount <= 0" (click)="openInstallmentModal(installmentModal, null)"
                      class="btn btn-soft-info btn-sm shadow-none"><i class="ri-add-line align-middle me-1"></i>{{ 'MODULES.ECOMMERCE.MAIN.ADD_INSTALLMENT' | translate }}</button>
                  </div>
                  <div *ngIf="installments?.length" class="table-responsive table-card">
                    <table class="table table-borderless align-middle mb-0">
                      <thead class="table-light text-muted">
                        <tr>
                          <th scope="col">{{ 'COMMON.AMOUNT' | translate }}</th>
                          <th scope="col">{{ 'MODULES.ECOMMERCE.MAIN.PAYMENT_METHOD' | translate }}</th>
                          <th scope="col">{{ 'MODULES.ECOMMERCE.MAIN.DEADLINE' | translate }}</th>
                          <th scope="col">{{ 'COMMON.ACTION' | translate }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let installment of installments?.value; let i = index">
                          <td> {{ +installment?.amount | currency:'DT':'symbol':'1.3-3' }} </td>
                          <td>
                            <div class="d-flex align-items-center">
                              <div class="flex-shrink-0 me-3">
                                <div class="avatar-sm bg-light p-1 rounded-circle"
                                  *ngIf="installment?.fullPaymentMethod?.images?.svg?.default?.baseUrl">
                                  <img
                                    [src]="installment?.fullPaymentMethod?.images?.svg?.default?.baseUrl + '/' + installment?.fullPaymentMethod?.images?.svg?.default?.path"
                                    class="img-fluid h-100 d-block">
                                </div>
                                <div class="avatar-sm bg-light rounded-circle p-1"
                                  *ngIf="!installment?.fullPaymentMethod?.images?.svg?.default?.baseUrl">
                                  <div class="avatar-title bg-soft-success text-success rounded-circle fs-13">
                                    {{installment?.fullPaymentMethod?.name?.charAt(0) || 'N'}}</div>
                                </div>
                              </div>
                              <span class="flex-grow-1 ms-2">
                                {{installment?.fullPaymentMethod?.name}}
                              </span>
                            </div>
                          </td>
                          <td>
                            {{ installment?.deadline | date: 'dd/MM/YYYY' }}
                          </td>
                          <td>
                            <div class="d-flex">
                              <a href="javascript:void(0);" class="d-block text-body p-1 px-2" data-bs-toggle="modal"
                                data-bs-target="#addAddressModal"
                                (click)="openInstallmentModal(installmentModal, installment, i)"><i
                                  class="ri-pencil-fill text-muted align-bottom me-1"></i>
                              </a>
                              <a href="javascript:void(0);" class="d-block text-body p-1 px-2" data-bs-toggle="modal"
                                data-bs-target="#addAddressModal" (click)="deleteInstall(i)"><i
                                  class="ri-delete-bin-fill text-muted align-bottom me-1"></i>
                              </a>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="d-flex align-items-start gap-3 mt-4">
                    <button (click)="backToShip()" type="button" class="btn btn-light btn-label previestab"
                      data-previous="pills-bill-address-tab"><i
                        class="ri-arrow-left-line label-icon align-middle fs-16 me-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.BACK_TO_SHIPPING' | translate }}</button>
                    <button type="button"
                      [disabled]="resAmount > 0 || orderForm.invalid || isOrderButtonDisabled || resAmount < 0"
                      (click)="addOrder()" class="btn btn-primary btn-label right ms-auto nexttab"
                      data-nexttab="pills-finish-tab"><i
                        class="ri-shopping-basket-line label-icon align-middle fs-16 ms-2"></i>{{ 'MODULES.ECOMMERCE.MAIN.COMPLETE_ORDER' | translate }}</button>
                  </div>
                </ng-template>
              </li>
            </ul>
          </div>
          <div class="tab-content">
            <div [ngbNavOutlet]="customNav"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card">
        <div class="card-header">
          <div class="d-flex">
            <div class="flex-grow-1">
              <h5 class="card-title mb-0">{{ 'MODULES.ECOMMERCE.MAIN.ORDER_SUMMARY' | translate }}</h5>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive table-card">
            <form [formGroup]="priceForm">
              <table *ngIf="products.value?.length" class="table table-borderless align-middle  mb-0">
                <thead class="table-light text-muted">
                  <tr>
                    <th style="width: 90px;" scope="col">{{ 'MODULES.ECOMMERCE.MAIN.PRODUCTS' | translate }}</th>
                    <th scope="col">{{ 'MODULES.ECOMMERCE.MAIN.PRODUCT_INFO' | translate }}</th>
                    <th scope="col" class="text-end">{{ 'MODULES.INVOICING.PURCHASES.SUPPLIERS.PRICE' | translate }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let barcode of products?.value; let i = index">
                    <td>
                      <div class="avatar-md bg-light rounded p-1">
                        <img *ngIf="barcode?.media?.pictures?.length"
                          [src]="barcode?.media.pictures[0]?.baseUrl + '/' + barcode.media.pictures[0]?.path"
                          class="img-fluid h-100 d-block">
                        <div *ngIf="!barcode?.media?.pictures.length"
                          class="avatar-title bg-soft-success text-success fs-13">
                          {{barcode?.name?.charAt(0) || 'N'}}</div>
                      </div>
                    </td>
                    <td>
                      <h5 class="fs-14"><a class="text-dark">
                          {{barcode?.name?.length > 18 ?
                          barcode?.name.substr(0,18) + '...' :
                          barcode?.name}}</a></h5>
                      <p class="text-muted mb-0">{{((barcode?.price) || 0) | currency:'DT':'symbol':'1.3-3'}} x
                        {{barcode?.quantity}} </p>
                      <div class="d-flex">
                        <div class="cursor-pointer me-2" (click)="barcode?.quantity > 1 ? minusQuntity(i) : null">
                          <i class="ri-subtract-line"></i>
                        </div>
                        <span class="w-4 text-center">{{ barcode?.quantity }}</span>
                        <span class="cursor-pointer ms-2" (click)="addQuantity(i)">
                          <i class="ri-add-line"></i>
                        </span>
                      </div>
                    </td>
                    <td class="d-block text-end">
                      <div class="d-flex justify-content-end">
                        <i (click)="removeArticle(i)" class="ri-delete-bin-fill"></i>
                      </div>
                      <span>{{ (((barcode?.price) || 0) * barcode?.quantity) |
                        currency:'DT':'symbol':'1.3-3' }}</span>
                    </td>
                  </tr>
                </tbody>
              </table>
              <table *ngIf="products.value?.length"
                class="table table-borderless d-flex justify-content-end  table-sm align-middle mb-0">
                <tbody>
                  <tr formGroupName="totalPrice">
                    <th scope="row">{{ 'COMMON.SUBTOTAL' | translate }}: </th>
                    <td>
                      <div class="input-group">
                        <input type="text" class="form-control bg-light border-0" id="cart-subtotal" placeholder="$0.00"
                          readonly formControlName="net">
                        <div class="input-group-text" *ngIf="totalLoading">
                          <div class="spinner-border avatar-xxs text-dark input-spinner" role="status"><span
                              class="sr-only">{{ 'COMMON.LOADING' | translate }}</span></div>
                        </div>
                        <span class="input-group-text">DT</span>
                      </div>
                    </td>
                  </tr>
                  <tr *ngIf="orderForm.get(['discount', 'amount']).value">
                    <th scope="row">{{ 'MODULES.ECOMMERCE.MAIN.DISCOUNT' | translate }}: </th>
                    <td>
                      <div class="input-group">
                        <input type="text" class="form-control bg-light border-0" id="cart-subtotal" placeholder="$0.00"
                          readonly [value]="orderForm.get(['discount', 'amount']).value">
                        <div class="input-group-text" *ngIf="totalLoading">
                          <div class="spinner-border avatar-xxs text-dark input-spinner" role="status"><span
                              class="sr-only">{{ 'COMMON.LOADING' | translate }}</span></div>
                        </div>
                        <span class="input-group-text">DT</span>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <th scope="row">{{ 'COMMON.TAX' | translate }}: </th>
                    <td>
                      <div class="input-group">
                        <input type="text" class="form-control bg-light border-0" id="cart-subtotal" placeholder="%0.00"
                          readonly formControlName="totalTax">
                        <div class="input-group-text" *ngIf="totalLoading">
                          <div class="spinner-border avatar-xxs text-dark input-spinner" role="status"><span
                              class="sr-only">{{ 'COMMON.LOADING' | translate }}</span></div>
                        </div>
                        <span class="input-group-text">%</span>
                      </div>
                    </td>
                  </tr>
                  <tr formGroupName="totalPrice">
                    <th scope="row">{{ 'COMMON.TOTAL' | translate }}: </th>
                    <td>
                      <div class="input-group">
                        <input readonly type="text" id="cart-subtotal" placeholder="$0.00" formControlName="gross"
                          class="form-control bg-light border-0">
                        <div class="input-group-text" *ngIf="totalLoading">
                          <div class="spinner-border avatar-xxs text-dark input-spinner" role="status"><span
                              class="sr-only">{{ 'COMMON.LOADING' | translate }}</span></div>
                        </div>
                        <span class="input-group-text">DT</span>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <th scope="row">{{ 'MODULES.ECOMMERCE.MAIN.DELIVERY_FEES' | translate }}: </th>
                    <td>
                      <div class="input-group">
                        <input readonly type="text" id="cart-subtotal" placeholder="$0.00"
                          formControlName="deliveryFees" class="form-control bg-light border-0">
                        <div class="input-group-text" *ngIf="totalLoading">
                          <div class="spinner-border avatar-xxs text-dark input-spinner" role="status"><span
                              class="sr-only">{{ 'COMMON.LOADING' | translate }}</span></div>
                        </div>
                        <span class="input-group-text">DT</span>
                      </div>
                    </td>
                  </tr>
                  <ng-container *ngIf="totalFees > 0">
                    <tr *ngFor="let fee of orderSettings?.extraFees">
                      <th scope="row">{{fee?.key}}: </th>
                      <td>
                        <div class="input-group">
                          <input [value]="fee?.value" readonly type="text" id="cart-subtotal" placeholder="$0.00"
                            class="form-control bg-light border-0">
                          <div class="input-group-text" *ngIf="totalLoading">
                            <div class="spinner-border avatar-xxs text-dark input-spinner" role="status"><span
                                class="sr-only">{{ 'COMMON.LOADING' | translate }}</span></div>
                          </div>
                          <span class="input-group-text">DT</span>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                  <tr class="border-top border-top-dashed">
                    <th scope="row">{{ 'MODULES.ECOMMERCE.MAIN.NET_TO_PAY' | translate }}</th>
                    <td>
                      <div class="input-group">
                        <input readonly type="text" id="cart-total" placeholder="$0.00" formControlName="toPay"
                          class="form-control bg-light border-0">
                        <div class="input-group-text" *ngIf="totalLoading">
                          <div class="spinner-border avatar-xxs text-dark input-spinner" role="status"><span
                              class="sr-only">{{ 'COMMON.LOADING' | translate }}</span></div>
                        </div>
                        <span class="input-group-text">DT</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div id="noresult" class="py-4 mt-4 text-center" *ngIf="!products.value?.length">
                <lord-icon trigger="loop" style="width:72px;height:72px" [colors]="'primary:' + primaryColor + ',secondary:' + secondaryColor"
                  src="https://cdn.lordicon.com/vlycxjwx.json">
                </lord-icon>
                <h5 class="mt-4">{{ 'COMMON.NO_RESULT' | translate }}</h5>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #installmentModal role="document" let-modal>
    <div class="modal-header bg-light p-3">
      <h5 class="modal-title" id="exampleModalLabel">{{'COMMON.EDIT' | translate }} installment</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close-modal"
        (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="installmentForm">
        <div class="row">
          <div class="mb-3 col-sm-6">
            <label for="zip" class="form-label">{{ 'COMMON.AMOUNT' | translate }}*</label>
            <input formControlName="amount" type="number" class="form-control" id="zip" placeholder="{{'PLACEHOLDER.ENTER_AMOUNT' | translate }}">
          </div>
          <div class="mb-3 col-sm-6">
            <label for="choices-privacy-status-input" class="form-label">{{ 'MODULES.ECOMMERCE.MAIN.DEADLINE' | translate }}</label>
            <div class="input-group">
              <input formControlName="deadline" [inline]="false" class="form-control bg-light border-light" type="text"
                mwlFlatpickr [altInput]="true" [convertModelValue]="true"
                placeholder="{{ 'COMMON.SELECT_DATE_RANGE' | translate }}" id="isDate">
              <span *ngIf="installmentForm.get('deadline').value" (click)="resetDate()" class="input-group-text"><i class="ri-close-fill fs-16"></i></span>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label for="country" class="form-label">{{ 'MODULES.ECOMMERCE.MAIN.PAYMENT_METHOD' | translate }}*</label>
          <ng-select formControlName="paymentMethod" placeholder="{{'PLACEHOLDER.CHOOSE_PAYMENT_METHOD' | translate }}" required [multiple]="false"
            [items]="paymentMethods$ | async">
            <ng-template ng-label-tmp let-item="item" let-clear="clear">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="avatar-sm bg-light p-1 rounded-circle" *ngIf="item?.images?.svg?.default?.baseUrl">
                    <img [src]="item?.images?.svg?.default?.baseUrl + '/' + item?.images?.svg?.default?.path"
                      class="img-fluid h-100 d-block">
                  </div>
                  <div class="avatar-sm bg-light rounded-circle p-1" *ngIf="!item?.images?.svg?.default?.baseUrl">
                    <div class="avatar-title bg-soft-success text-success rounded-circle fs-13">
                      {{item?.name?.charAt(0) || 'N'}}</div>
                  </div>
                </div>
                <span class="flex-grow-1 ms-2">
                  {{item?.name}}
                </span>
              </div>
              <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">×</span>
            </ng-template>
            <ng-template ng-option-tmp let-item$="item$" let-item="item">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <div class="avatar-sm bg-light p-1 rounded-circle" *ngIf="item?.images?.svg?.default?.baseUrl">
                    <img [src]="item?.images?.svg?.default?.baseUrl + '/' + item?.images?.svg?.default?.path"
                      class="img-fluid h-100 d-block">
                  </div>
                  <div class="avatar-sm bg-light rounded-circle p-1" *ngIf="!item?.images?.svg?.default?.baseUrl">
                    <div class="avatar-title bg-soft-success text-success rounded-circle fs-13">
                      {{item?.name?.charAt(0) || 'N'}}</div>
                  </div>
                </div>
                <span class="flex-grow-1 ms-2">
                  {{item?.name}}
                </span>
              </div>
            </ng-template>
          </ng-select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <div class="hstack gap-2 justify-content-end">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal" (click)="modal.close('Close click')">{{
          'COMMON.CLOSE' | translate }}</button>
        <button type="button" [disabled]="installmentForm.invalid || isInstButtonDisabled" (click)="saveInstallment()"
          class="btn btn-success" id="add-btn">{{'COMMON.SAVE' | translate }}</button>
      </div>
    </div>
  </ng-template>

  <ng-template #locationModal role="document" let-modal>
    <div class="modal-header bg-light p-3">
      <h5 class="modal-title" id="exampleModalLabel">{{(selectedShipAddress ? 'SHARED.EDIT_SHIPPING_ADDRESS'
        : 'SHARED.ADD_SHIPPING_ADDRESS') | translate}}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close-modal"
        (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body">
      <ng-container *ngIf="step === 1">
        <agm-map [latitude]="36.60650973504423" [longitude]="9.633264627829647" [zoom]="6"
          (mapClick)="pickAddress($event)">
          <agm-marker *ngIf="cords" [latitude]="cords.lat" [longitude]="cords.lng">
          </agm-marker>
        </agm-map>
        <div class="d-flex justify-content-center gap-2 mt-3">
          <button type="button" [disabled]="!cords.lng" (click)="next()" class="btn btn-success"
            id="add-btn">{{'MODULES.WEBSITE.NEXT' | translate }}</button>
          <button type="button" (click)="next()" class="btn btn-info" id="add-btn">Skip</button>
        </div>
      </ng-container>
      <div *ngIf="step === 2">
        <form [formGroup]="shippingForm">
          <div class="row g-3">
            <div class="mb-3">
              <label for="billinginfo-address" class="form-label">{{'COMMON.ADDRESS' | translate }} line*</label>
              <textarea required formControlName="address" class="form-control" id="billinginfo-address"
                placeholder="{{'PLACEHOLDER.ENTER_ADDRESS' | translate }}" rows="3"></textarea>
            </div>
            <div class="row">
              <div class="mb-3 col-sm-6">
                <div class="mb-3">
                  <label for="choices-status-input" class="form-label">{{ 'COMMON.COUNTRIES' | translate }}</label>
                  <ng-select (change)="onChangeCountry($event)" [hideSelected]="true" [virtualScroll]="true"
                    (scrollToEnd)="loadMoreCountries()" placeholder="{{'PLACEHOLDER.ENTER_COUNTRIES' | translate }}" bindlabel="name"
                    bindValue="id" [items]="filteredCountries" [multiple]="false" [formControlName]="'country'">
                    <ng-template ng-label-tmp let-item="item" let-clear="clear">
                      <span class="me-1" *ngIf="item?.iconFlag">{{item?.iconFlag}}</span>
                      <span>{{item?.name?.split('_').join(' ') | titlecase}}</span>
                      <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">×</span>
                    </ng-template>
                    <ng-template ng-option-tmp let-item="item">
                      <span class="me-1" *ngIf="item?.iconFlag">{{item?.iconFlag}}</span>
                      <span>{{item?.name?.split('_').join(' ') | titlecase}}</span>
                    </ng-template>
                  </ng-select>
                </div>
              </div>

              <div class="mb-3 col-sm-6">
                <div class="mb-3">
                  <label for="choices-status-input" class="form-label">{{ 'COMMON.STATES' | translate }}</label>
                  <ng-select bindlabel="name" bindValue="id" [items]="filteredStates" [multiple]="false"
                    [hideSelected]="true" [virtualScroll]="true" [formControlName]="'state'"
                    placeholder="{{'PLACEHOLDER.ENTER_STATE' | translate }}">
                    <ng-template ng-label-tmp let-item="item" let-clear="clear">
                      <span>{{item?.name?.split('_').join(' ') | titlecase}}</span>
                      <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">×</span>
                    </ng-template>
                    <ng-template ng-option-tmp let-item="item">
                      <span>{{item?.name?.split('_').join(' ') | titlecase}}</span>
                    </ng-template>
                  </ng-select>
                </div>
              </div>
              <div class="mb-3 col-sm-6">
                <label for="zip" class="form-label">{{'COMMON.CITY' | translate }}*</label>
                <input formControlName="city" type="text" class="form-control" id="zip" placeholder="{{'PLACEHOLDER.ENTER_CITY' | translate }}">
              </div>
              <div class="mb-3 col-sm-6">
                <div class="mb-3">
                  <label for="zip" class="form-label">{{ 'COMMON.ZIP_CODE' | translate }}*</label>
                  <input formControlName="postCode" type="text" class="form-control" id="zip"
                    placeholder="{{'PLACEHOLDER.ENTER_ZIP_CODE' | translate }}">
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div *ngIf="step === 2" class="modal-footer">
      <div class="hstack gap-2 justify-content-end">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal" (click)="modal.close('Close click')">{{
          'COMMON.CLOSE' | translate }}</button>
        <button type="button" [disabled]="shippingForm.invalid || isShipButtonDisabled" (click)="saveShipAddress()"
          class="btn btn-success" id="add-btn">{{(selectedShipAddress ? 'SHARED.EDIT_SHIPPING_ADDRESS'
          : 'SHARED.ADD_SHIPPING_ADDRESS') | translate }}</button>
      </div>
    </div>
  </ng-template>

  <ng-template #deleteModel let-modal>
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="btn-close"
          (click)="modal.dismiss('Cross click')"></button>
      </div>
      <div class="modal-body">
        <div class="mt-2 text-center">
          <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop"
            colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
          <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
            <h4>{{ 'MODULES.ECOMMERCE.MAIN.YOU_ARE_ABOUT_TO_DELETE_A_SHIPPING_ADDRESS' | translate }}</h4>
            <p class="text-muted mx-4 mb-0">{{ 'MODULES.ECOMMERCE.MAIN.DELETING_YOUR_SHIPPING_ADDRESS_WILL_REMOVE_ALL_OF_YOUR_INFORMATION_FROM_OUR_DATABASE' | translate }}
            </p>
          </div>
        </div>
        <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
          <button class="btn btn-link link-success fw-medium text-decoration-none" data-bs-dismiss="modal"
            (click)="modal.close('Close click')" id="deleteRecord-close"><i
              class="ri-close-line me-1 align-middle"></i>{{ 'COMMON.CLOSE' | translate }}</button>
          <button type="button" class="btn w-sm btn-danger " id="delete-product" (click)="deleteShippingAddress()"
            (click)="modal.close('Close click')">{{ 'COMMON.YES_DELETE_IT' | translate }}</button>
        </div>
      </div>
    </div>
  </ng-template>
</ng-container>
<div *ngIf="navigating$ | async" class="vh-100 py-4 text-center" fxLayout="column" fxLayoutAlign="center center"
  fxLayoutGap="1rem">
  <div>
    <lord-icon trigger="loop" style="width:72px;height:72px" [colors]="'primary:' + primaryColor + ',secondary:' + secondaryColor"
      src="https://cdn.lordicon.com/msoeawqm.json">
    </lord-icon>
  </div>
  <div class="mt-4">
    <h5>{{ 'COMMON.LOADING' | translate }}</h5>
  </div>
</div>
